<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#e30613" />
  <title>üì¶ CALCULADORA DE FECHA DE ENTREGA üì¶</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <img src="logo-tm-white.webp" alt="Logo Tiendamia" class="logo-top">
  <header>üì¶ CALCULADORA DE FECHA DE ENTREGA üì¶</header>

  <main class="container" role="main">
    <div class="content">
      <h1>Completa los datos</h1>
      <p class="helper">Cuenta <strong>d√≠as h√°biles</strong> desde la fecha de compra, saltando fines de semana y los feriados del pa√≠s seleccionado.</p>

      <form id="calcForm" novalidate>
        <div class="field">
          <label for="country">Pa√≠s</label>
          <select id="country" required>
            <option value="" disabled selected>Selecciona un pa√≠s</option>
            <option value="Uruguay">Uruguay</option>
            <option value="Costa Rica">Costa Rica</option>
            <option value="Peru">Per√∫</option>
            <option value="Ecuador">Ecuador</option>
            <option value="Argentina">Argentina</option>
          </select>
        </div>

        <div class="field">
          <label for="purchaseDate">Fecha de compra</label>
          <input id="purchaseDate" type="date" required />
        </div>

        <div class="field">
          <label for="bizDays">D√≠as h√°biles</label>
          <input id="bizDays" type="number" min="1" max="75" step="1" placeholder="Ej. 11" required />
        </div>

        <div class="actions">
          <button type="submit" class="primary">Calcular entrega</button>
          <button type="button" id="btnClear" class="ghost" aria-label="Limpiar">Limpiar</button>
        </div>

        <div id="warn" class="warn" role="alert"></div>
        <div id="result" class="result">
          <strong>Fecha estimada:</strong> <span id="outDate">--/--/----</span>
        </div>
      </form>
    </div>
  </main>

  <footer>
    Demo de calculadora de fecha de entrega
  </footer>

  <img src="TiendamiaLogo.png" alt="Tiendamia logo" class="logo-brand">

  <script>
    // ---- Utilidades ----
    function pad(n){ return String(n).padStart(2,'0'); }
    function toISODate(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
    function fromInputDate(v){
      if(!v) return null;
      const [y,m,d] = v.split('-').map(Number);
      return new Date(y, m-1, d, 12, 0, 0); // siempre al mediod√≠a local
    }

    // ---- Cargar feriados ----
    let feriadosData = {};
    async function cargarFeriados() {
      try {
        const res = await fetch("feriados.json", { cache: "no-store" });
        if (!res.ok) throw new Error("No se pudo cargar feriados.json");
        feriadosData = await res.json();
      } catch (err) {
        console.error("‚ùå Error cargando feriados:", err);
        feriadosData = {};
      }
    }

    // ---- C√°lculo de entrega ----
    function calcularEntrega(pais, fechaCompra, diasHabiles) {
      if (!fechaCompra) throw new Error("Fecha de compra inv√°lida");
      if (!diasHabiles || diasHabiles <= 0) throw new Error("D√≠as h√°biles inv√°lidos");

      const paisNorm = pais.toUpperCase();
      const fecha = fromInputDate(fechaCompra); // ‚úÖ ahora siempre usamos la funci√≥n segura
      let restantes = diasHabiles;

      // Preparar lista de feriados
      const anio = fecha.getFullYear();
      const lista = (feriadosData[paisNorm] && feriadosData[paisNorm][anio]) || [];
      const feriados = new Set(lista.map(d => d));

      // üöÄ Iniciar desde el d√≠a siguiente
      fecha.setDate(fecha.getDate() + 1);

      while (restantes > 0) {
        const iso = toISODate(fecha);
        const dow = fecha.getDay(); // 0=domingo, 6=s√°bado
        const isWeekend = (dow === 0 || dow === 6);
        const isHoliday = feriados.has(iso);

        if (!isWeekend && !isHoliday) {
          restantes--;
        }

        if (restantes > 0) {
          fecha.setDate(fecha.getDate() + 1);
        }
      }

      return fecha;
    }

    // ---- Conectar con UI ----
    document.addEventListener("DOMContentLoaded", async () => {
      await cargarFeriados();

      const form = document.getElementById("calcForm");
      const out = document.getElementById("outDate");
      const warn = document.getElementById("warn");
      const resultBox = document.getElementById("result");
      const btnClear = document.getElementById("btnClear");

      form.addEventListener("submit", (ev) => {
        ev.preventDefault();
        warn.style.display = "none";
        resultBox.style.display = "none";

        const pais = document.getElementById("country").value;
        const fechaStr = document.getElementById("purchaseDate").value;
        const dias = Number(document.getElementById("bizDays").value);

        if (!pais || !fechaStr || !dias) {
          warn.textContent = "‚ö†Ô∏è Completa todos los campos.";
          warn.style.display = "block";
          return;
        }

        try {
          const fechaEntrega = calcularEntrega(pais, fechaStr, dias);
          out.textContent = fechaEntrega.toLocaleDateString("es-ES", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric"
          });
          resultBox.style.display = "block";
        } catch (err) {
          warn.textContent = "‚ùå Error: " + err.message;
          warn.style.display = "block";
        }
      });

      btnClear.addEventListener("click", () => {
        form.reset();
        out.textContent = "--/--/----";
        warn.style.display = "none";
        resultBox.style.display = "none";
      });
    });
  </script>
</body>
</html>
