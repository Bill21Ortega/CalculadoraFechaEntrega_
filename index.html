<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#e30613" />
  <title>üì¶ CALCULADORA DE FECHA DE ENTREGA üì¶</title>
  <link rel="stylesheet" href="style.css" />
<!-- prueba de commit -->

</head>
<body>
    <img src="logo-tm-white.webp" alt="Logo Tiendamia" class="logo-top">
    <header>üì¶ CALCULADORA DE FECHA DE ENTREGA üì¶</header>
  <main class="container" role="main">
    <div class="content">
      <h1>Completa los datos</h1>
      <p class="helper">Cuenta <strong>d√≠as h√°biles</strong> desde la fecha de compra, saltando fines de semana y los feriados del pa√≠s seleccionado.</p>

      <form id="calcForm" novalidate>
        <div class="field">
          <label for="country">Pa√≠s</label>
        <select id="country" required>
            <option value="" disabled selected>Selecciona un pa√≠s</option>
            <option value="Uruguay">Uruguay</option>
            <option value="Costa Rica">Costa Rica</option>
            <option value="Peru">Per√∫</option>
            <option value="Ecuador">Ecuador</option>
            <option value="Argentina">Argentina</option>
        </select>

        </div>

        <div class="field">
          <label for="purchaseDate">Fecha de compra</label>
          <input id="purchaseDate" type="date" required />
        </div>

        <div class="field">
          <label for="bizDays">D√≠as h√°biles</label>
          <input id="bizDays" type="number" min="1" max="75" step="1" placeholder="Ej. 11" required />

        </div>

        <div class="actions">
          <button type="submit" class="primary">Calcular entrega</button>
          <button type="button" id="btnClear" class="ghost" aria-label="Limpiar">Limpiar</button>
        </div>

        <div id="warn" class="warn" role="alert"></div>
        <div id="result" class="result"><strong>Fecha estimada:</strong> <span id="outDate">--/--/----</span></div>
      </form>
    </div>
  </main>

  <footer>
    Demo de calculadora de fecha de entrega
  </footer>

  <script>
    // ---- Utilidades de fecha ----
    function pad(n){ return String(n).padStart(2,'0'); }
    function toISODate(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
    function fromInputDate(v){ // evita problemas de zona horaria creando la fecha al mediod√≠a local
      if(!v) return null; const [y,m,d] = v.split('-').map(Number); return new Date(y, (m-1), d, 12, 0, 0);
    }
    function normalizeKey(s){ return (s||'').normalize('NFD').replace(/[^\p{Letter}\p{Number}]+/gu,'').toUpperCase(); }

    // ---- Estado ----
    const HOLIDAYS = new Map(); // clave pa√≠s normalizado -> Set(YYYY-MM-DD)
    let holidaysLoaded = false;

    async function loadHolidays(){
      const warn = document.getElementById('warn');
      try {
        const res = await fetch('feriados.json', { cache: 'no-store' });
        if(!res.ok) throw new Error('No se pudo cargar feriados.json');
        const data = await res.json();
        for(const key in data){
          const norm = normalizeKey(key);
          HOLIDAYS.set(norm, new Set(data[key]));
        }
        holidaysLoaded = true;
        warn.style.display = 'none';
     } catch(err){
  console.warn("No se pudo cargar feriados.json. Se calcular√° solo con fines de semana.");
  // warn.textContent = 'Aviso...';
  // warn.style.display = 'block';
}

    }

    function isHoliday(date, country){
      const set = HOLIDAYS.get(normalizeKey(country));
      if(!set) return false; // si no hay lista, no bloquea
      return set.has(toISODate(date));
    }

    function computeDelivery(startDate, bizDays, country){
      if(!(startDate instanceof Date) || isNaN(startDate)) throw new Error('Fecha inv√°lida');
      if(!Number.isFinite(bizDays) || bizDays <= 0) throw new Error('D√≠as h√°biles inv√°lidos');

      let current = new Date(startDate.getTime());
      current.setDate(current.getDate() + 1); // inicia al d√≠a siguiente

      let remaining = Math.trunc(bizDays);
      let guard = 0; // evita loops infinitos en caso extremo
      while(remaining > 0 && guard < 5000){
        const dow = current.getDay(); // 0=dom,6=s√°b
        const weekend = (dow === 0 || dow === 6);
        const holiday = isHoliday(current, country);
        if(!weekend && !holiday){ remaining--; }
        if(remaining > 0) current.setDate(current.getDate() + 1);
        guard++;
      }
      return current; // fecha final cuando remaining llega a 0
    }

    function formatLongEs(date){
      return date.toLocaleDateString('es-419', { day:'2-digit', month:'long', year:'numeric' });
    }

    // ---- Hook UI ----
    document.addEventListener('DOMContentLoaded', () => {
      loadHolidays();

      const form = document.getElementById('calcForm');
      const out = document.getElementById('outDate');
      const resultBox = document.getElementById('result');
      const warn = document.getElementById('warn');
      const btnClear = document.getElementById('btnClear');

      form.addEventListener('submit', (ev) => {
        ev.preventDefault();
        warn.style.display = 'none';
        resultBox.style.display = 'none';

        const country = document.getElementById('country').value;
        const dateStr = document.getElementById('purchaseDate').value;
        const daysStr = document.getElementById('bizDays').value;

        if(!country || !dateStr || !daysStr){
          warn.textContent = 'Por favor completa todos los campos.';
          warn.style.display = 'block';
          return;
        }

        const startDate = fromInputDate(dateStr);
        const bizDays = Number(daysStr);

        try{
          const delivery = computeDelivery(startDate, bizDays, country);
          out.textContent = formatLongEs(delivery);
          resultBox.style.display = 'block';
        } catch(err){
          warn.textContent = 'Error: ' + err.message;
          warn.style.display = 'block';
        }
      });

     btnClear.addEventListener('click', () => {
        form.reset(); // üî• Resetea todo el formulario a su estado inicial
        warn.style.display = 'none';
        resultBox.style.display = 'none';
    });
    });
  </script>
  <script>
async function cargarFeriados() {
  try {
    const res = await fetch("feriados.json", { cache: "no-store" });
    if (!res.ok) throw new Error("No se pudo cargar feriados.json");
    feriadosData = await res.json();
    console.log("‚úÖ Feriados cargados:", feriadosData);
  } catch (err) {
    console.error("‚ùå Error cargando feriados:", err);
    feriadosData = {};
  }
}

// Ejecutar al cargar la p√°gina
cargarFeriados();
</script>
<script>
async function calcularEntrega(pais, fechaCompra, diasHabiles) {
  const feriadosData = await cargarFeriados();

  // Normalizar pa√≠s
  const paisNorm = pais.toUpperCase();

  if (!feriadosData[paisNorm]) {
    throw new Error("Pa√≠s no soportado: " + pais);
  }

  // Tomar a√±o de la fecha de compra
  let fecha = new Date(fechaCompra);
  let anio = fecha.getFullYear();

  // Convertir lista de feriados del a√±o en Set para b√∫squeda r√°pida
  const feriados = new Set(
    (feriadosData[paisNorm][anio] || []).map(d => new Date(d).getTime())
  );

  // Avanzar d√≠a por d√≠a hasta cumplir d√≠as h√°biles
  let restantes = diasHabiles;
  while (restantes > 0) {
    fecha.setDate(fecha.getDate() + 1); // siguiente d√≠a
    const dow = fecha.getDay(); // 0 domingo, 6 s√°bado
    const isWeekend = (dow === 0 || dow === 6);
    const isHoliday = feriados.has(new Date(fecha).getTime());
    if (!isWeekend && !isHoliday) {
      restantes--;
    }
  }

  return fecha;
}

// Ejemplo de uso para probar
(async () => {
  const resultado = await calcularEntrega("URUGUAY", "2025-08-10", 11);
  console.log("üìÖ Fecha de entrega:", resultado.toDateString());
})();
</script>
<script>
  // ---- Utilidades ----
  function pad(n){ return String(n).padStart(2,'0'); }
  function toISODate(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
  function fromInputDate(v){
    if(!v) return null;
    const [y,m,d] = v.split('-').map(Number);
    return new Date(y, (m-1), d, 12, 0, 0); // al mediod√≠a local
  }

  // ---- Cargar feriados ----
  let feriadosData = {};
  async function cargarFeriados() {
    try {
      const res = await fetch("feriados.json", { cache: "no-store" });
      if (!res.ok) throw new Error("No se pudo cargar feriados.json");
      feriadosData = await res.json();
      console.log("‚úÖ Feriados cargados:", feriadosData);
    } catch (err) {
      console.error("‚ùå Error cargando feriados:", err);
      feriadosData = {};
    }
  }

  // ---- C√°lculo de entrega ----
  function calcularEntrega(pais, fechaCompra, diasHabiles) {
    if (!fechaCompra) throw new Error("Fecha de compra inv√°lida");
    if (!diasHabiles || diasHabiles <= 0) throw new Error("D√≠as h√°biles inv√°lidos");

    const paisNorm = pais.toUpperCase();
    const fecha = new Date(fechaCompra);
    let restantes = diasHabiles;

    // Preparar lista de feriados
    const anio = fecha.getFullYear();
    const lista = (feriadosData[paisNorm] && feriadosData[paisNorm][anio]) || [];
    const feriados = new Set(lista.map(d => d));

    while (restantes > 0) {
      fecha.setDate(fecha.getDate() + 1);
      const iso = toISODate(fecha);
      const dow = fecha.getDay(); // 0=domingo, 6=s√°bado
      const isWeekend = (dow === 0 || dow === 6);
      const isHoliday = feriados.has(iso);
      if (!isWeekend && !isHoliday) {
        restantes--;
      }
    }

    return fecha;
  }

  // ---- Conectar con UI ----
  document.addEventListener("DOMContentLoaded", async () => {
    await cargarFeriados();

    const form = document.getElementById("calcForm");
    const out = document.getElementById("outDate");
    const warn = document.getElementById("warn");
    const resultBox = document.getElementById("result");
    const btnClear = document.getElementById("btnClear");

    form.addEventListener("submit", (ev) => {
      ev.preventDefault();
      warn.style.display = "none";
      resultBox.style.display = "none";

      const pais = document.getElementById("country").value;
      const fechaStr = document.getElementById("purchaseDate").value;
      const dias = Number(document.getElementById("bizDays").value);

      if (!pais || !fechaStr || !dias) {
        warn.textContent = "‚ö†Ô∏è Completa todos los campos.";
        warn.style.display = "block";
        return;
      }

      try {
        const fechaEntrega = calcularEntrega(pais, fechaStr, dias);
        out.textContent = fechaEntrega.toLocaleDateString("es-ES", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric"
        });
        resultBox.style.display = "block";
      } catch (err) {
        warn.textContent = "‚ùå Error: " + err.message;
        warn.style.display = "block";
      }
    });

    btnClear.addEventListener("click", () => {
      document.getElementById("purchaseDate").value = "";
      document.getElementById("bizDays").value = "";
      out.textContent = "--/--/----";
      warn.style.display = "none";
      resultBox.style.display = "none";
    });
  });
</script>
<img src="TiendamiaLogo.png" alt="Tiendamia logo" class="logo-brand">
</body>
</html>
